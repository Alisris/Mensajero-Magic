<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cliente WebSocket</title>
  <style>
    body { font-family: Arial, sans-serif; }
    #chat { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; }
    input[type="text"] { width: 300px; padding: 5px; }
    button { padding: 5px 10px; }
    #emoji-picker {
      font-size: 20px;
      cursor: pointer;
      margin-left: 10px;
    }
    #emoji-list {
      display: none;
      position: absolute;
      border: 1px solid #ccc;
      background: white;
      padding: 10px;
      border-radius: 5px;
      margin-top: 5px;
      z-index: 1;
    }
    .emoji {
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
    }
    .message {
      margin: 5px 0;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
    }
    .delete-btn {
      cursor: pointer;
      color: red;
      font-size: 14px;
    }
    #user-list {
      margin-top: 10px;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }
    #user-list ul {
      list-style-type: none;
      padding: 0;
    }
    #user-list li {
      padding: 5px;
      font-weight: bold; /* Nombres en negrita */
      text-transform: uppercase; /* Nombres en mayÃºsculas */
    }
  </style>
</head>
<body>
  <h1>Magic Chat</h1>
  <div>
    <input type="text" id="username" placeholder="Nombre de usuario">
    <button onclick="connect()">Conectar</button>
  </div>
  
  <!-- Lista de usuarios conectados -->
  <div id="user-list">
    <h3>Usuarios Conectados</h3>
    <ul id="userList"></ul>
  </div>

  <div id="chat"></div>

  <input type="text" id="message" placeholder="Escribe un mensaje..." disabled>
  <button onclick="sendMessage()" disabled>Enviar</button>

  <span id="emoji-picker">ğŸ˜Š</span> <!-- BotÃ³n para abrir el selector de emojis -->
  <div id="emoji-list">
    <!-- Lista de emojis -->
    <span class="emoji" onclick="addEmoji('ğŸ˜Š')">ğŸ˜Š</span>
    <span class="emoji" onclick="addEmoji('ğŸ˜‚')">ğŸ˜‚</span>
    <span class="emoji" onclick="addEmoji('ğŸ˜')">ğŸ˜</span>
    <span class="emoji" onclick="addEmoji('ğŸ˜¢')">ğŸ˜¢</span>
    <span class="emoji" onclick="addEmoji('ğŸ˜')">ğŸ˜</span>
    <span class="emoji" onclick="addEmoji('ğŸ‘')">ğŸ‘</span>
    <span class="emoji" onclick="addEmoji('ğŸ‘‹')">ğŸ‘‹</span>
    <span class="emoji" onclick="addEmoji('â¤ï¸')">â¤ï¸</span>
  </div>

  <script>
    let socket;
    const chat = document.getElementById('chat');
    const messageInput = document.getElementById('message');
    const usernameInput = document.getElementById('username');
    const sendButton = document.querySelector('button[onclick="sendMessage()"]');
    const emojiPicker = document.getElementById('emoji-picker');
    const emojiList = document.getElementById('emoji-list');
    const userList = document.getElementById('userList');

    // Conectar al servidor WebSocket
    function connect() {
      const username = usernameInput.value.trim();
      if (!username) {
        alert('Por favor, ingresa un nombre de usuario');
        return;
      }

      socket = new WebSocket('ws://localhost:8080');

      socket.onopen = () => {
        socket.send(JSON.stringify({ action: 'authenticate', username }));
      };

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        switch (data.action) {
          case 'authenticated':
            alert(data.message);
            break;

          case 'authorized':
            if (data.success) {
              messageInput.disabled = false;
              sendButton.disabled = false;
              alert(data.message);
            } else {
              alert(data.message);
              socket.close();
            }
            break;

          case 'message':
            displayMessage(data.username, data.text, data.timestamp, data.id);
            break;

          case 'userList':
            updateUserList(data.users);
            break;

          default:
            console.error('AcciÃ³n desconocida:', data.action);
        }
      };

      socket.onclose = () => {
        messageInput.disabled = true;
        sendButton.disabled = true;
      };

      socket.onerror = (err) => {
        console.error('Error:', err);
      };
    }

    // Enviar mensaje
    function sendMessage() {
      const message = messageInput.value.trim();
      if (message) {
        const timestamp = new Date().toLocaleString();
        const messageObj = {
          text: message,
          timestamp: timestamp,
          id: Date.now(), // Usamos un ID Ãºnico basado en el timestamp
          username: usernameInput.value.trim()
        };
        socket.send(JSON.stringify({ action: 'message', ...messageObj }));
        messageInput.value = '';
      }
    }

    // Mostrar mensaje en el chat
    function displayMessage(username, text, timestamp, id) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');
      messageDiv.id = id;

      const messageContent = document.createElement('span');
      messageContent.textContent = `[${timestamp}] ${username}: ${text}`;

      const deleteBtn = document.createElement('span');
      deleteBtn.textContent = 'Eliminar';
      deleteBtn.classList.add('delete-btn');
      deleteBtn.onclick = () => deleteMessage(id);

      messageDiv.appendChild(messageContent);
      messageDiv.appendChild(deleteBtn);
      chat.appendChild(messageDiv);
      chat.scrollTop = chat.scrollHeight; // Desplazar al final del chat
    }

    // Eliminar mensaje
    function deleteMessage(id) {
      const messageDiv = document.getElementById(id);
      messageDiv.remove();
      socket.send(JSON.stringify({ action: 'delete', id: id }));
    }

    // FunciÃ³n para agregar un emoji al mensaje
    function addEmoji(emoji) {
      messageInput.value += emoji;
      emojiList.style.display = 'none'; // Cerrar el selector de emojis despuÃ©s de seleccionar
    }

    // Mostrar u ocultar la lista de emojis cuando se hace clic en el emoji picker
    emojiPicker.onclick = () => {
      emojiList.style.display = emojiList.style.display === 'block' ? 'none' : 'block';
    };

    // Actualizar la lista de usuarios conectados
    function updateUserList(users) {
      userList.innerHTML = ''; // Limpiar la lista de usuarios
      users.forEach(user => {
        const userItem = document.createElement('li');
        userItem.textContent = user;
        userList.appendChild(userItem);
      });
    }
  </script>
</body>
</html>

